# Setup an LLM Chat + Generative AI responses with MySQL HeatWave

![mysql heatwave](./images/mysql-heatwave-logo.jpg "mysql heatwave")

## Introduction

In this Lab, you will be guided into the process of setting up an AI Chat, leveraging MySQL Heatwave Generative AI which enable us to use an embeded LLM (Large Language Model) inside MySQL Database to start using a chatbot and later erich the provided answers with RAG (Retreival Augmented Generation), by providing text based documents as context for the answer generation.

When you run HeatWave Chat, it automatically loads the LLM model. If you don’t have a vector store set up, then
HeatWave Chat uses information available in public data sources to generate a response for your query. However, if
you have a vector store set up, then HeatWave Chat by default performs a global context search across all the loaded
vector store tables to generate a response for your query.

_Estimated Time:_ 10 minutes

### Objectives

In this lab, you will be guided through the following task:

- Set Up the HeatWave Chat with Generative AI
- Generate text based content
- Compare the content generated by general LLM training vs RAG with Vector Store

### Prerequisites

- An Oracle Trial or Paid Cloud Account
- Some Experience with MySQL Shell
- Completed Lab 6

## Task 1: Running the Chat. Use MySQL Heatwave chat function to generate text-based content


1. To delete previous chat output and state if any, reset the @chat_options session variable:

       ```bash
       <copy>set @chat_options=NULL; </copy>
       ```

2. Then, add your query to HeatWave Chat by using the heatwave_chat method:
**call sys.heatwave\_chat("<YourQuery>");**
For example:

       ```bash
       <copy>call sys.heatwave_chat("What is HeatWave AutoML?"); </copy>
       ```

3. You will get a response based on the LLM general training.

   

## Task 2: Add Text Based documents on OCI Object Store Buckets

You may use any text based document that you like. For this lab, we have provided the following document.

1. Click on this link to **Download file** [HeatwaveInfo.pdf](https://objectstorage.us-ashburn-1.oraclecloud.com/p/CUCCtrIsxGslRW6HbL6FRZWh8lZzPTOBy_ihyS7B0ec5t4h3voGK5eL9kjk2dpQA/n/idi1o0a010nx/b/Bucket-CA/o/GEN-AI/heatwave-en-2.pdf) to your local machine. **This PDF file can be used to upload and create the vector table for the next Tasks**

2. In the Buckets page, click the **Your-Bucket-Name** name to load images into. The bucket's details page is displayed.
3. Under Resources, click Objects to display the list of objects in the bucket.
4. Click Upload under the default or custom folder. The Upload Objects pane is displayed.
5. Select a Text Based Document **Your-Document.pdf** file from your local machine
    - Click open to load the **Your-Document.pdf** file
    - Click the Upload button
      
       ![bucket detail](./images/genai-bucket-detail.png"bucket-detail.png")

    - Wait for the **Abort** to change into **close**
    - Click the **close** button

## Task 3: Create the PAR Link for the files

1. To create a PAR URL
    - Go to menu **Storage —> Buckets**
      
     ![Bucket menu](./images/genai-storage-bucket-menu.png "storage bucket menu")

    - Select **Your-Custom-Folder**  folder.
2. Select your text based file —> **Your-Document.pdf** and click the three vertical dots.
3. Click on **Create Pre-Authenticated Request**

    ![delivery-orders-1.csv 3 dots](./images/genai-storage-create-par-orders.png "storage create par orders")

4. Choose the **Object-with-prefix** option.
5. Keep **Permit object reads** selected.
6. Kep the other options for **Access Type** unchanged.
7. Check the **Enable Object Listing** checkbox.
8. Click the **Create Pre-Authenticated Request** button.

    ![Create PAR](./images/genai-bucket-PAR.png "storage create par orders page")

9. Click the **Copy** icon to copy the PAR URL.
    ![Copy PAR](./images/genai-storage-create-par-orders-page-copy.png "storage create par orders page copy")

10. **Save the generated PAR URL**; you will need it in a task later

## Task 4: Create the vector store database for the vector tables

1. Connect to OCI Cloud Shell
    ![mysql shell open drawer](./images/cloudshell-console-drawer.png "cloudshell console drawer")

2. On command Line, connect to the HeatWave Database using the MySQL Shell client tool with the following command:

       ```bash
       <copy>mysqlsh -uadmin -p -h 10.0.1... --sql </copy>
       ```

    ![mysql shell start](./images/mysql-shell-start.png "mysql shell start ")

3. On command Line, Run the next command to create a database called **vectordb1**:
   
       ```bash
       <copy>CREATE SCHEMA `vectordb1`; </copy>
       ```
     
## Task 5: Load the Text Based documents into a vector table, using MySQL HeatWave AutoPilot

1. On command Line, Run the next command to SET a variable that stores the table and files parameter:
2. Name your table\_name with a name related to your text file, under **"table\_name": "tablename"**
3. Paste the **PAR** url copied from the task 2 and replace it under **"par": "https ://objectstorage.us-ashbu... "**

       ```bash
       <copy>
       SET @dl_tables = '[{
       "db_name": "vectordb1",
       "tables": [{
       "table_name": "Document1",
       "dialect": {
       "format": "pdf",
       "language": "es",
       "ocr": true
       },
       "file": [{
       "par": "https://objectstorage.us-ashburn-1.oraclecloud.com/p/y4TeTCJxA8niTVW2R81Qs6YCO7xi7foUC6UtTKisEZRvCWNtiJDHlAySB8k2m340/n/idi1o0a010nx/b/Bucket-CA/o/"
       }]
       }]
       }]';</copy>
       ```

5. On command Line, Run the next command to SET a variable that stores the database list

    ```bash
    <copy>SET @db_list = '["vectordb1"]'; </copy>
    ```
6. On command Line, Run the next command to SET a variable that stores the procedure options

    ```bash
    <copy>
    SET @options = JSON_OBJECT(
    'output', 'normal',
    'policy', 'disable_unsupported_columns',
    'external_tables', CAST(@dl_tables AS JSON)
    ); </copy>
    ```

7. On command Line, Run the next command to load the file into your **database.table** using the previous options

    ```bash
    <copy>CALL sys.heatwave_load(@db_list, @options); </copy>
    ```

## Task 6: Validate your new vector table with the text based document content

1. On command Line, Run the next command to Validate your **database.table** by counting the \# of Rows

    ```bash
    <copy>SELECT COUNT(*) FROM vectordb1.Document1; </copy>
    ```
2. On command Line, Run the next command to inspect the content of a row in your **database.table**

    ```bash
    <copy>SELECT * FROM vectordb1.Document1 LIMIT 1\G </copy>
    ```

## Task 7: Compare the chat generated responses between general training and RAG responses

1. Re run your previous queries to HeatWave Chat by using the heatwave_chat method:
**call sys.heatwave\_chat("<YourQuery>");**
For example:

       ```bash
       <copy>call sys.heatwave_chat("What is HeatWave AutoML?"); </copy>
       ```

2. This time, you will get a response based on the Vector Store tables, with the Text Based Documents.
   
       ```bash
       <copy>SET @options = JSON_OBJECT("schema", JSON_ARRAY("vectordb1.Document1"), "model_options", JSON_OBJECT("language", "es"));
       SET @query="What is HeatWave AutoML?";

       CALL sys.ML_RAG(@query,@output,@options);
       SELECT JSON_PRETTY(@output) \G </copy>
       ```

## Task 8: Further improve RAG capabilities with Custom RAG procedura

1. Create a Store Procedure to improve RAG capabilities:

       ```bash
       <copy>DROP PROCEDURE IF EXISTS RAG_Plus3;
       DELIMITER //
       CREATE DEFINER=`admin`@`%` PROCEDURE `RAG_Plus3`(
           IN input_query TEXT, -- Input query for the RAG process
           IN table_name TEXT,  -- Table name for the vector store
           OUT result TEXT      -- Output variable to store the result
       )
       BEGIN
           DECLARE output TEXT;
           DECLARE response TEXT;
           DECLARE citations TEXT;
           DECLARE citation_len INT DEFAULT 0;
           DECLARE segments TEXT DEFAULT '';
           DECLARE segment TEXT;
           DECLARE k INT DEFAULT 0;
           DECLARE vector_store_json TEXT;
       
           -- Construct the vector store JSON dynamically
           SET vector_store_json = CONCAT('"', table_name, '"');
       
           -- Construct the dynamic SQL query for sys.ML_RAG
           SET @rag_query = CONCAT(
               "CALL sys.ML_RAG('", 
               input_query, "', ", -- Use the input_query value directly in the string
               "@output, JSON_OBJECT(",
               "'skip_generate', TRUE, ",
               "'schema', JSON_ARRAY(", vector_store_json, "), ",
               "'model_options', JSON_OBJECT(",
               "'model_id', 'llama3-8b-instruct-v1', ",
               "'language', 'es' ",
               "), ",
               "'n_citations', 10))"
           );
       
           -- Execute the dynamic SQL query
           PREPARE rag_stmt FROM @rag_query;
           EXECUTE rag_stmt;
           DEALLOCATE PREPARE rag_stmt;
       
           -- Extract response and citations from the JSON
           SET output = @output;
           SET response = JSON_UNQUOTE(JSON_EXTRACT(output, '$.text'));
           SET citations = JSON_UNQUOTE(JSON_EXTRACT(output, '$.citations'));
           SET citation_len = JSON_LENGTH(citations);
           SET segments = "";
       
           -- Build the segments from the citations
           WHILE k < citation_len DO
               SET segment = JSON_UNQUOTE(JSON_EXTRACT(citations, CONCAT('$[', k, '].segment')));
               SET segments = CONCAT(segments, ' ', segment);
               SET k = k + 1;
           END WHILE;
       
           -- Generate the final query based on the context and original question
           SET @query = CONCAT(
               "Con base en el contexto proporcionado, responda a la siguiente pregunta asegurándose de no incluir información que viole la ni la ley de protección de datos personales identificables (PII) ni la ley de información protegida de salud (PHI): ",
               input_query, 
               " De contexto ", 
               segments
           );
       
           -- Execute the sys.ML_GENERATE function to get the final result
           SELECT sys.ML_GENERATE(@query,
               JSON_OBJECT(
                   'task', 'generation', 
                   'model_id', 'llama3-8b-instruct-v1', 
                   'language', 'es'
               )
           ) INTO result;
       END //
       DELIMITER ; </copy>
       ```
   
3. Compare agains the regular HeatWave Chat and RAG

       ```bash
       <copy>CALL RAG_Plus3("What is HeatWave AutoML?","vectordb1.Document1",@result);
       SELECT JSON_PRETTY(@result); </copy>
       ```

You may now **proceed to the next lab**

## Learn More

- [Oracle Cloud Infrastructure MySQL Database Service Documentation](https://docs.cloud.oracle.com/en-us/iaas/MySQL-database)
- [MySQL Database Documentation](https://www.MySQL.com)

You may now **proceed to the next lab**

## Acknowledgements

- **Author** - Cristian Aguilar, MySQL Staff Solution Engineering
- **Contributors** - Perside Foster, MySQL Solution Engineering
- **Last Updated By/Date** - Cristian Aguilar, MySQL Staff Solution Engineering, August 2024
